name: Release - Nightly

on:
  workflow_dispatch:
  # At 03:00 (UTC) daily
  # https://crontab.guru/#0_3_*_*_*
  # This is a good time for nightly builds, across CET, PST and IST (QA team in India)
  schedule:
    - cron: '0 3 * * *'

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    needs: [check-date, ios, android]
    if: ${{ needs.check-date.outputs.should-run != 'false' }}
    name: Generate release notes
    env:
      NIGHTLY_TAG_NAME: 'valora-nightly'
      CURRENT_RELEASE_SHA: ${{ needs.check-date.outputs.latest-commit-hash }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch all history for all tags and branches
          fetch-depth: 0
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: celo-mobile-mainnet
          credentials_json: ${{ secrets.GCP_MAINNET_RELEASE_AUTOMATION_SERVICE_ACCOUNT_KEY }}
      - name: Google Secrets
        id: google-secrets
        uses: google-github-actions/get-secretmanager-secrets@v2
        with:
          secrets: |-
            SLACK_WEBHOOK_URL:projects/1027349420744/secrets/SLACK_WEBHOOK_URL
            BOT_SSH_KEY:projects/1027349420744/secrets/BOT_SSH_PRIVATE_KEY
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ steps.google-secrets.outputs.BOT_SSH_KEY }}
      - name: Generate release notes
        run: |
          set -euo pipefail
          previous_release_sha="$(git show-ref -s tags/$NIGHTLY_TAG_NAME)"
          echo "Store commits between previous release "$previous_release_sha" and current release "$CURRENT_RELEASE_SHA""
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$(git rev-list "$previous_release_sha".."$CURRENT_RELEASE_SHA" --oneline)" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      - name: Delete previous nightly release tag
        run: |
          set -euo pipefail
          git tag -d $NIGHTLY_TAG_NAME
          # --no-verify to bypass pre-push script in wallet that is preventing tag deletion
          git push origin --delete tags/$NIGHTLY_TAG_NAME --no-verify
      - name: Tag new nightly release
        run: |
          set -euo pipefail
          git tag $NIGHTLY_TAG_NAME "$CURRENT_RELEASE_SHA"
          git push origin --tags
      - name: Build notification
        uses: edge/simple-slack-notify@v1.1.2
        with:
          status: success
          success_text: 'ðŸš€ There are new features available for testing on the nightly builds! ðŸ¥³'
          # the RELEASE_NOTES are generated in the previous step
          fields: |
            [
              {
                "title": "New items",
                "value": ${JSON.stringify(env.RELEASE_NOTES)}
              }
            ]
        env:
          SLACK_WEBHOOK_URL: ${{ steps.google-secrets.outputs.SLACK_WEBHOOK_URL }}
